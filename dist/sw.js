importScripts("https://storage.googleapis.com/workbox-cdn/releases/6.5.4/workbox-sw.js");const{precaching,routing,strategies}=workbox,CACHE_NAME="story-app-v1";precaching.precacheAndRoute([{url:"/",revision:null},{url:"/index.html",revision:null},{url:"/favicon.png",revision:null},{url:"/images/logo.png",revision:null},{url:"/images/icons/icon-192x192.png",revision:null},{url:"/images/icons/icon-512x512.png",revision:null},{url:"/manifest.json",revision:null}]),routing.registerRoute((({request:e})=>"image"===e.destination),new strategies.CacheFirst({cacheName:"story-app-images",plugins:[new workbox.expiration.ExpirationPlugin({maxEntries:60,maxAgeSeconds:2592e3})]})),routing.registerRoute((({request:e})=>"script"===e.destination||"style"===e.destination),new strategies.StaleWhileRevalidate({cacheName:"story-app-static"})),routing.registerRoute((({url:e})=>e.href.includes("/v1/stories")),new strategies.StaleWhileRevalidate({cacheName:"story-app-api",plugins:[new workbox.expiration.ExpirationPlugin({maxEntries:50,maxAgeSeconds:604800})]}));let lastNotifiedStoryId=null;self.addEventListener("fetch",(e=>{e.request.url.includes("/v1/stories")?e.respondWith(fetch(e.request).then((async e=>{const t=e.clone();try{const e=await t.json();if(e&&e.stories&&e.stories.length>0){const t=e.stories[0];t.id!==lastNotifiedStoryId&&(lastNotifiedStoryId=t.id,(await self.clients.matchAll()).forEach((e=>{e.postMessage({type:"CHECK_NOTIFICATION_PREFERENCE",story:{id:t.id,name:t.name,description:t.description,photoUrl:t.photoUrl}})})))}}catch(e){console.error("Error processing story data:",e)}return e})).catch((()=>caches.match(e.request)))):e.respondWith(caches.match(e.request).then((t=>t||fetch(e.request).then((t=>t&&200===t.status?caches.open("story-cache").then((i=>(i.put(e.request,t.clone()),t))):t)))).catch((()=>caches.match("/fallback.json"))))})),self.addEventListener("message",(e=>{if(e.data&&"SHOW_NOTIFICATION"===e.data.type){const{title:t,body:i,url:n,image:s}=e.data;self.registration.showNotification(t,{body:i,icon:"/favicon.png",badge:"/favicon.png",image:s||"/images/logo.png",data:{url:n||"/"}})}})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=e.notification?.data?.url||"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const i of e)if(i.url===t&&"focus"in i)return i.focus();if(clients.openWindow)return clients.openWindow(t)})))}));